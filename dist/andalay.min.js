angular.module("Andalay",["underscore"]).factory("Andalay",["$http","$q","$parse","_",function(a,b,c,d){"use strict";var e={};e.Model=function(a,b){var c=a||{};b=b||{},this.cid=d.uniqueId("c"),b.parse&&(c=this.parse(c,b)||{}),c=d.defaults({},c,angular.copy(d.result(this,"defaults"))),c&&angular.extend(this,c),this.initialize.apply(this,arguments)},e.Model.prototype={idAttribute:"id",loading:!1,saving:!1,defaults:{},initialize:function(){},toJSON:function(){var a=angular.copy(this);return delete a.collection,delete a.cid,a},has:function(a){return angular.isDefined(this[a])},parse:function(a){return a},isNew:function(){return!this.has(this.idAttribute)},isValid:function(){return this.validate()},url:function(){var a=d.result(this,"urlRoot")||d.result(this.collection,"url")||i();if(this.isNew())return a;var b=this.id||this[this.idAttribute];return a.replace(/([^\/])$/,"$1/")+encodeURIComponent(b)},validate:function(){return!0},sync:function(){return e.sync.apply(this,arguments)},fetch:function(a){a=a?d.clone(a):{},void 0===a.parse&&(a.parse=!0);var b=this;return b.loading=!0,this.sync("read",this,a).then(function(c){b.loading=!1;var d=a.parse?b.parse(c.data):c.data;angular.extend(b,d)},function(){throw new Error("Error retrieving model")})},save:function(a){var c=this.isNew()?"create":"update";a=d.defaults(a||{},{validate:!0}),this.setSaving(!0);var e=b.defer();a.validate&&!this.validate()&&e.reject("Validation failed");var f=this;return this.sync(c,this,a).then(function(a){f.setSaving(!1),angular.extend(f,f.parse(a.data)),e.resolve(a)},function(a){f._errors=a.data,e.reject(a)})},"delete":function(){var a=this;return a.loading=!0,this.sync("delete",this).then(function(){a.loading=!1,angular.isDefined(a.collection)&&a.collection.remove(a.id),a[a.idAttribute]=null},function(){throw new Error("Error deleting model")})},_errors:{},setSaving:function(a){this.saving=a,this.collection&&(this.collection.saving=a)}};var f=["keys","values","pairs","invert","pick","omit","chain","isEmpty"];d.each(f,function(a){d[a]&&(e.Model.prototype[a]=function(){var b=[].slice.call(arguments);return b.unshift(this),d[a].apply(d,b)})}),e.Collection=function(a,b){b=b||{},b.model&&(this.model=b.model),this._reset(),this.initialize.apply(this,arguments),a&&this.reset(a)},e.Collection.prototype={model:e.Model,loading:!1,saving:!1,models:[],_index:{},length:0,initialize:function(){},toJSON:function(){var a=[];return this.forEach(function(b){a.push(b.toJSON())}),a},addOne:function(a,b){var c;if(b=b||{},d.isArray(a))throw new Error("The object to add must be an object. Array given");if(!d.isObject(a))throw new Error('Cannot add "'+a+'" to the collection. You must specify an object to add');c=void 0!==b.at?b.at:this.models.length;var e=this.get(a);return this.exists(a)?angular.extend(e,a):(e=this._prepareModel(a),this._addReference(e),this.models.splice(c,0,e),this.length+=1),e},parse:function(a){return a},addMany:function(a){if(!d.isArray(a))throw new Error("Cannot add "+a+", models must be an array of objects");for(var b=[],c=0;c<a.length;c++){var e=a[c];b.push(this.addOne(e))}return b},updateMany:function(a){return this.addMany(a)},reset:function(a){return this._reset(),a?this.addMany(a):[]},get:function(a){return a||0===a?this._index[a]||this._index[this.modelId(a)]||this._index[a.cid]:void 0},exists:function(a){return!angular.isUndefined(this.get(a))},update:function(a){return this.addOne(a)},remove:function(a){var b=this.get(a);if(d.isUndefined(b))return void 0;this._removeReference(b);var c=d.indexOf(this.models,b);return this.models.splice(c,1),this.length--,b},removeAll:function(){return this.reset(),this},modelId:function(a){return a[this.model.prototype.idAttribute||"id"]},last:function(){return this.models[this.length-1]},at:function(a){return this.models[a]},size:function(){return this.models.length},all:function(){return this.models},where:function(a,b){var c=d.matches(a);return this[b?"find":"filter"](function(a){return c(a)})},findWhere:function(a){return this.where(a,!0)},sync:function(){return e.sync.apply(this,arguments)},fetch:function(a){a=a?d.clone(a):{},void 0===a.parse&&(a.parse=!0);var b=this;return b.loading=!0,this.sync("read",this,a).then(function(c){b.loading=!1;var d=a.parse?b.parse(c.data):c.data;b.addMany(d)},function(){})},_reset:function(){this.length=0,this.models=[],this._index={}},_prepareModel:function(a){var b=a;return b=a instanceof e.Model?a:new this.model(a),b.collection=this,b},_addReference:function(a){this._index[a.cid]=a;var b=this.modelId(a);angular.isDefined(b)&&null!==b&&(this._index[b]=a)},_removeReference:function(a){delete this._index[a.cid];var b=this.modelId(a);angular.isDefined(b)&&null!==b&&delete this._index[b]}};var g=["forEach","each","find","filter"];d.each(g,function(a){d[a]&&(e.Collection.prototype[a]=function(){var b=[].slice.call(arguments);return b.unshift(this.models),d[a].apply(d,b)})}),e.sync=function(b,c,e){var f={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};e=e||{};var g={method:f[b]};angular.isUndefined(e.url)&&(g.url=d.result(c,"url")||i()),d.isUndefined(e.data)&&c&&("create"===b||"update"===b||"patch"===b)&&(g.data=c.toJSON());var h=angular.extend(g,e);return c.saving=!0,a(h)};var h=function(a,b){var c,e=this;c=a&&d.has(a,"constructor")?a.constructor:function(){return e.apply(this,arguments)},d.extend(c,e,b);var f=function(){this.$constructor=c};return f.prototype=e.prototype,c.prototype=new f,a&&d.extend(c.prototype,a),c.__super__=e.prototype,c},i=function(){throw new Error('A "url" property or function must be specified in the collection. If the model is not added to a collection it should have a urlRoot property')};return e.Model.extend=e.Collection.extend=h,e}]);